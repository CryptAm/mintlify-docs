---
title: "Написание тестов"
description: "Научитесь писать комплексные тесты для блокчейна с помощью OnchainTestKit"
---

Это руководство охватывает всё необходимое для написания тестов с OnchainTestKit: от базового подключения кошелька до сложных сценариев транзакций. ОБРАТИТЕ ВНИМАНИЕ, что некоторые из этих примеров могут отличаться от вашей реализации в зависимости от фронтенд-кода.

## Доступные фикстуры

OnchainTestKit предоставляет несколько фикстур для ваших тестов:

<Info>
Фикстуры автоматически внедряются в ваши тестовые функции и обрабатывают настройку и завершение.
</Info>

| Фикстура | Тип  | Описание    |
|----------|------|-------------|
| `page` | `Page` | Объект страницы Playwright для автоматизации браузера |
| `metamask` | Интерфейс автоматизации кошелька `MetaMask` |
| `coinbase` | Интерфейс автоматизации кошелька `Coinbase` |
| `node` | `LocalNodeManager` | Менеджер локального узла блокчейна |
| `smartContractManager` | `SmartContractManager` | Деплой и взаимодействие со смарт-контрактами |

## Базовые операции с кошельками

### Подключение кошелька

<Tabs>
<Tab title="MetaMask">
```typescript
test("connect MetaMask", async ({ page, metamask }) => {
  if (!metamask) throw new Error("MetaMask not initialized")

  // Открываем модальное окно подключения кошелька
  await page.getByTestId("ockConnectButton").first().click()

  // Выбираем MetaMask из вариантов кошельков
  await page
    .getByTestId("ockModalOverlay")
    .first()
    .getByRole("button", { name: "MetaMask" })
    .click()

  // Обрабатываем запрос на подключение в MetaMask
  await metamask.handleAction(BaseActionType.CONNECT_TO_DAPP)
})
```
</Tab>

<Tab title="Coinbase Wallet">
```typescript
test("connect Coinbase Wallet", async ({ page, coinbase }) => {
  if (!coinbase) throw new Error("Coinbase not initialized")

  // Открываем модальное окно подключения кошелька
  await page.getByTestId("ockConnectButton").first().click()

  // Выбираем Coinbase из вариантов кошельков
  await page
    .getByTestId("ockModalOverlay")
    .first()
    .getByRole("button", { name: "Coinbase" })
    .click()

  // Обрабатываем запрос на подключение в Coinbase
  await coinbase.handleAction(BaseActionType.CONNECT_TO_DAPP)
})
```
</Tab>
</Tabs>

### Переключение сети

```typescript
test("switch networks", async ({ page, metamask }) => {
  // Сначала подключаем кошелек
  await connectWallet(page, metamask)

  // Переключаемся на Base Sepolia
  await page.getByTestId("switch-to-base-sepolia").click()
  
  // Обрабатываем смену сети в кошельке
  await metamask.handleAction(BaseActionType.SWITCH_NETWORK)
})
```

## Тестирование транзакций

### Базовая транзакция

```typescript
test("send transaction", async ({ page, metamask }) => {
  // Подключаем кошелек
  await connectWallet(page, metamask)

  // В идеале у вас есть кнопка покупки
  
  // Отправляем транзакцию
  await page.getByTestId("purchase-button").click()

  // Подтверждаем транзакцию в кошельке
  await metamask.handleAction(BaseActionType.HANDLE_TRANSACTION, {
    approvalType: ActionApprovalType.APPROVE,
  })

  // Ждем подтверждения
  await expect(page.getByText("Transaction confirmed!")).toBeVisible()
})
```

### Отклонение транзакций

```typescript
test("reject transaction", async ({ page, metamask }) => {
  await connectWallet(page, metamask)

  // Инициируем транзакцию
  await page.getByTestId("purchase-button").click()

  // Отклоняем в кошельке
  await metamask.handleAction(BaseActionType.HANDLE_TRANSACTION, {
    approvalType: ActionApprovalType.REJECT,
  })

  // Проверяем обработку отклонения
  await expect(page.getByText("Transaction rejected")).toBeVisible()
})
```

## Продвинутые паттерны тестирования

### Параллельное выполнение тестов

```typescript
test.describe.parallel("Parallel tests", () => {
  test("test 1", async ({ page, metamask, node }) => {
    console.log(`Test 1 using port: ${node?.port}`)
    // Каждый тест получает свой изолированный узел
  })

  test("test 2", async ({ page, metamask, node }) => {
    console.log(`Test 2 using port: ${node?.port}`)
    // Разный порт, изолированное окружение
  })
})
```

## Рекомендации

<Steps>

<Step title="Ожидание изменений состояния">
Всегда ожидайте обновления UI после действий с кошельком:

```typescript
// Хорошо
await metamask.handleAction(BaseActionType.CONNECT_TO_DAPP)
await page.waitForSelector('[data-testid="wallet-connected"]')

// Плохо - может быть нестабильным
await metamask.handleAction(BaseActionType.CONNECT_TO_DAPP)
expect(page.getByText("Connected")).toBeVisible() // Might fail
```
</Step>

<Step title="Корректная обработка ошибок">
Всегда включайте сценарии с ошибками в свои тесты:

```typescript
test("handle wallet rejection", async ({ page, metamask }) => {
  try {
    await metamask.handleAction(BaseActionType.CONNECT_TO_DAPP, {
      approvalType: ActionApprovalType.REJECT,
    })
  } catch (error) {
    // Проверяем, что ошибка обработана в UI
    await expect(page.getByText("Connection rejected")).toBeVisible()
  }
})
```
</Step>
</Steps>

## Отладка тестов

### Визуальная отладка

```bash
# Запуск тестов в режиме с открытым браузером
yarn playwright test --headed

# Использование Playwright Inspector
yarn playwright test --debug

# Замедление выполнения
yarn playwright test --slow-mo=1000
```

### Логи в консоли

```typescript
test("debug test", async ({ page, metamask }) => {
  // Логируем ошибки страницы
  page.on('pageerror', error => {
    console.error('Page error:', error)
  })

  // Логируем сообщения консоли
  page.on('console', msg => {
    console.log('Console:', msg.text())
  })

  // Ваш тестовый код
})
```

## Интеграция с CI/CD

### Пример GitHub Actions

```yaml
name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Set up Corepack + yarn
        run: |
          npm install -g corepack
          yarn set version 4.9.2

      - name: Install root dependencies
        run: yarn

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Build contracts
        run: |
          cd smart-contracts
          forge install foundry-rs/forge-std
          forge install OpenZeppelin/openzeppelin-contracts
          forge build

      - name: Install Playwright browsers
        run: yarn playwright install --with-deps

      - name: Prepare wallet extensions
        run: |
          yarn prepare-metamask
          yarn prepare-coinbase

      - name: Build application
        run: |
          echo "E2E_TEST_SEED_PHRASE=${{ secrets.E2E_TEST_SEED_PHRASE }}" > .env
          echo "E2E_CONTRACT_PROJECT_ROOT=../smart-contracts" >> .env
          yarn build

      - name: Install xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run E2E tests
        env:
          NODE_OPTIONS: '--dns-result-order=ipv4first'
        run: xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" yarn test:e2e
```

## Следующие шаги

Начните тестировать ваше ончейн-приложение уже сегодня:

1. Установите OnchainTestKit в ваш проект
2. Напишите ваш первый тест, следуя примерам выше
3. Интегрируйте тесты в ваш CI/CD конвейер
4. Расширяйте покрытие тестами по мере создания новых функций
5. Посмотрите [примеры тестов](https://github.com/coinbase/onchaintestkit/tree/master/example/frontend/e2e)
6. Ознакомьтесь с [полной документацией](https://onchaintestkit.xyz/)

Помните: комплексное тестирование ведет к созданию более надежных ончейн-приложений и лучшему пользовательскому опыту.
