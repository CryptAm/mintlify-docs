---
title: Диаграмма EVM
description: Обзор виртуальной машины Ethereum
---

В этой статье мы рассмотрим внутреннюю работу EVM, ее компоненты и ее роль в сети Ethereum.

---

## Цели

К концу этого урока вы сможете:

- Описать схему работы EVM

---

## Что такое EVM?

Виртуальная машина Ethereum (EVM) - это основной движок Ethereum. Это полная по Тьюрингу (Turing-complete), изолированная виртуальная машина, предназначенная для выполнения смарт-контрактов в сети. Термин «изолированная» (sandboxed) означает, что EVM работает в изолированной среде, гарантируя, что выполнение каждого смарт-контракта не мешает другим или базовому блокчейну. Как мы уже узнали, природа EVM, полная по Тьюрингу, позволяет разработчикам писать сложные программы, которые могут выполнять любую вычислительно выполнимую задачу.

EVM использует сложную систему управления ресурсами с помощью газа (gas) для регулирования затрат на вычисления и предотвращения злоупотреблений сетью. Она также поддерживает богатую экосистему приложений, предоставляя универсальный набор опкодов (opcodes) для логики смарт-контрактов и способствуя взаимодействию с различными языками программирования, инструментами и технологиями. Эта адаптивность сделала EVM фундаментальным компонентом в развитии и росте сети Ethereum.

---

## Компоненты EVM

EVM имеет несколько ключевых компонентов, которые позволяют ей обрабатывать и управлять смарт-контрактами. Давайте определим их:

- **Состояние мира:** Представляет всю сеть Ethereum, включая все аккаунты и связанное с ними хранилище.
- **Аккаунты:** Участники, взаимодействующие с сетью Ethereum, включая Аккаунты, принадлежащие извне (EOAs), и Контрактные аккаунты.
- **Хранилище:** Хранилище ключ-значение, связанное с каждым контрактным аккаунтом, содержащее состояние и данные контракта.
- **Газ:** Механизм измерения стоимости выполнения операций в EVM, который защищает сеть от спама и злоупотреблений.
- **Опкоды:** Низкоуровневые инструкции, которые EVM выполняет во время обработки смарт-контракта.
- **Стек выполнения:** Структура данных «последним пришел - первым ушел» (LIFO) для временного хранения значений во время выполнения опкодов.
- **Память:** Память времени выполнения, используемая смарт-контрактами во время выполнения.
- **Счетчик команд:** Регистр, который отслеживает позицию следующего опкода, который будет выполнен.
- **Логи:** События, генерируемые смарт-контрактами во время выполнения, которые могут использоваться внешними системами для мониторинга или реагирования на конкретные события.

---

## Модель выполнения EVM

Проще говоря, когда транзакция отправляется в сеть, EVM сначала проверяет ее валидность. Если транзакция признана валидной, EVM устанавливает контекст выполнения, который включает текущее состояние сети, и обрабатывает байт-код смарт-контракта с помощью опкодов. По мере того как EVM запускает смарт-контракт, она изменяет состояние мира блокчейна и потребляет газ соответственно. Однако если транзакция оказывается невалидной, она отклоняется сетью без дальнейшей обработки. На протяжении выполнения смарт-контракта генерируются логи, которые дают представление о производительности контракта и любых сгенерированных событиях. Эти логи могут использоваться внешними системами для целей мониторинга или реагирования на конкретные события.

<Frame>
![EVM Execution Model](/images/learn/ethereum-virtual-machine/evm-execution-basic.png)
</Frame>

---

## Газ и выполнение опкодов

Хотя мы уже подробно рассмотрели концепцию газа в предыдущем уроке, стоит повторить его критическую роль в EVM и как фундаментального компонента Ethereum. Газ функционирует как метрика для количественной оценки вычислительных усилий, необходимых для выполнения операций в EVM. Каждый опкод в смарт-контракте имеет определенную стоимость газа, которая отражает вычислительные ресурсы, необходимые для его выполнения.

Опкоды - это низкоуровневые инструкции, выполняемые EVM. Они представляют элементарные операции, которые позволяют EVM обрабатывать и управлять смарт-контрактами.

<Frame>
![Opcode Execution](/images/learn/ethereum-virtual-machine/opcode-execution.png)
</Frame>

Во время выполнения EVM читает опкоды из смарт-контракта, и в зависимости от опкода она может обновлять состояние мира, потреблять газ или откатывать состояние в случае ошибки. Некоторые распространенные опкоды включают:

- **ADD:** Складывает два значения из стека
- **SUB:** Вычитает два значения из стека.
- **MSTORE:** Сохраняет значение в памяти.
- **SSTORE:** Сохраняет значение в хранилище контракта.
- **CALL:** Вызывает другой контракт или отправляет эфир.

---

## Стек и память

Стек и память EVM являются критически важными компонентами архитектуры EVM, поскольку они позволяют смарт-контрактам управлять временными данными во время выполнения опкодов. Стек - это структура данных «последним пришел - первым ушел» (LIFO), которая используется для временного хранения значений во время выполнения опкодов. Он управляется EVM и отделен от хранилища контракта. Стек поддерживает две основные операции: push и pop.

Операция push добавляет значение в вершину стека, а операция pop удаляет верхнее значение из стека. Эти операции используются для управления временными данными во время выполнения опкодов. Например, опкод, выполняющий операцию сложения, может поместить два операнда в стек, выполнить сложение, а затем извлечь результат с вершины стека.

Во время выполнения контракта память служит набором байтов, организованных в массив, для временного хранения данных. Она может читаться и записываться опкодами. Память часто используется для хранения временных данных во время выполнения опкодов, например, при работе с данными динамического размера, такими как строки или массивы, которые обрабатываются или вычисляются внутри смарт-контракта перед сохранением в хранилище контракта. Когда смарт-контракту нужно сохранить временные данные во время выполнения опкодов, он может использовать память для хранения этих данных.

<Frame>
![EVM Stack and Memory](/images/learn/ethereum-virtual-machine/evm-stack-memory.png)
</Frame>

---

## Архитектура EVM и контекст выполнения

Чтобы полностью понять архитектуру EVM и ее компоненты, важно увидеть, как они все объединяются в единое целое. Следующая диаграмма предоставляет углубленную визуализацию архитектуры EVM, демонстрируя взаимодействие между ключевыми элементами, такими как транзакции, газ, опкоды и состояние мира. С помощью этой диаграммы вы можете увидеть, как каждый компонент играет жизненно важную роль в бесперебойном выполнении смарт-контрактов в сети Ethereum.

<Frame>
![Figure 13-1. EVM architecture and execution context.](/images/learn/ethereum-virtual-machine/evm-architecture-execution.png)
</Frame>
Image Source: [Mastering Ethereum](https://github.com/ethereumbook/ethereumbook) by Andreas M. Antonopoulos and Gavin Wood, licensed under [CC BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/)

---

## Заключение

EVM играет жизненно важную роль в сети Ethereum. Изучив ключевые компоненты EVM, а также ее архитектуру и модель выполнения, мы получили представление о движке Ethereum и о том, как он обеспечивает плавное выполнение смарт-контрактов на платформе.

---

## Смотрите также

- [The Ethereum Virtual Machine (Mastering Ethereum)](https://cypherpunks-core.github.io/ethereumbook/13evm.html#evm_architecture)
- [Ethereum Virtual Machine (Ethereum docs)](https://ethereum.org/en/developers/docs/evm/)


[the ethereum virtual machine (mastering ethereum)]: https://cypherpunks-core.github.io/ethereumbook/13evm.html#evm_architecture
