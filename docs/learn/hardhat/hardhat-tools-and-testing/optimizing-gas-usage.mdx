---
title: 'Hardhat: Оптимизация потребления газа смарт-контрактами'
slug: /hardhat-profiling-gas
description: Учебник, который учит, как оптимизировать потребление газа ваших смарт-контрактов с помощью Hardhat.
author: Edson Alcala and Brian Doyle
---

# Hardhat: Оптимизация потребления газа смарт-контрактами

В этом учебнике вы узнаете, как профилировать и оптимизировать потребление газа вашего смарт-контракта с помощью Hardhat и плагина [Hardhat Gas Reporter].



## Цели

К концу этого учебника вы сможете:

- Использовать плагин Hardhat Gas Reporter для профилирования расхода газа
- Описывать распространенные стратегии для улучшения расхода газа контракта



## Обзор

В мире разработки смарт-контрактов оптимизация потребления газа ваших смарт-контрактов важна. Меньшие контракты потребляют меньше ресурсов газа при развертывании и выполнении, что приводит к значительной экономии средств для ваших пользователей. В этом учебнике вы будете использовать плагин Hardhat Gas Reporter, чтобы помочь вам анализировать и оптимизировать потребление газа вашим смарт-контрактом.

Далее представлена дополнительная информация о профилировании смарт-контрактов и оптимизации газа.

## Настройка плагина Hardhat Gas Reporter

<Video videoId='867220421' title='Installing the Gas Analyzer' />

Плагин Hardhat Gas Reporter - это бесценный инструмент для профилирования расхода газа в ваших смарт-контрактах. Он позволяет получить представление о потреблении газа различных функций контракта, что упрощает поиск потенциальных возможностей для оптимизации. Этот инструмент особенно полезен во время разработки, когда вы хотите убедиться, что ваши контракты максимально эффективны с точки зрения газа.

Для установки выполните `npm install -D hardhat-gas-reporter`.

Затем импортируйте `hardhat-gas-reporter` в `hardhat.config.ts`:

```solidity
import "hardhat-gas-reporter"
```

Настройте плагин в файле `hardhat.config.ts`:

```tsx
const config: HardhatUserConfig = {
  // ....
  gasReporter: {
    enabled: true,
  },
};
```

После завершения настройки вы готовы использовать плагин.

## Ваше первое профилирование газа

Создайте контракт с именем `Store` со следующим содержимым:

```solidity
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

contract Store {
    address public owner;
    uint256 public numberOfItems;

    struct Item {
        uint256 id;
        string description;
        uint256 price;
    }

    // id => item
    mapping(uint256 => Item) public items;

    constructor() {
        owner = msg.sender;
    }

    function addItem(string memory description, uint256 price) external {
        require(msg.sender == owner, "invalid owner");

        numberOfItems++;

        items[numberOfItems] = Item(
            numberOfItems,
            description,
            price
        );
    }
}

```

Добавьте тестовый файл с именем `Store.test.ts`, чтобы протестировать плагин gas reporter. Тестовый файл должен содержать следующее:

```tsx
import { expect } from 'chai';
import { ethers } from 'hardhat';
import { HardhatEthersSigner } from '@nomicfoundation/hardhat-ethers/signers';

import { Store, Store__factory } from '../typechain-types';

describe('Store tests', function () {
  let instance: Store;
  let owner: HardhatEthersSigner;

  before(async () => {
    const signers = await ethers.getSigners();
    owner = signers[0];
    instance = await new Store__factory().connect(owner).deploy();
  });

  it('should add an item', async () => {
    const description = 'TShirt';
    const price = ethers.parseEther('1');

    await instance.addItem(description, price);

    expect(await instance.numberOfItems()).to.equal(1);
  });
});
```

Выполните `npx hardhat test`. Появится следующий отчет:

```
·------------------------|---------------------------|---------------|-----------------------------·
|  Solc version: 0.8.18  ·  Optimizer enabled: true  ·  Runs: 10000  ·  Block limit: 30000000 gas  │
·························|···························|···············|······························
|  Methods                                                                                         │
·············|···········|·············|·············|···············|···············|··············
|  Contract  ·  Method   ·  Min        ·  Max        ·  Avg          ·  # calls      ·  usd (avg)  │
·············|···········|·············|·············|···············|···············|··············
|  Store     ·  addItem  ·          -  ·          -  ·       113601  ·            1  ·          -  │
·············|···········|·············|·············|···············|···············|··············
|  Deployments           ·                                           ·  % of limit   ·             │
·························|·············|·············|···············|···············|··············
|  Store                 ·          -  ·          -  ·       428837  ·        1.4 %  ·          -  │
·------------------------|-------------|-------------|---------------|---------------|-------------·
```

Отчет предоставляет подробный обзор затрат газа для функции `addItem` и затрат на развертывание.

## Распространенные стратегии для оптимизации размера контрактов

<Video videoId='867222700' title='Improving Gas Usage' />

После выполнения первого профилирования газа вы можете начать продумывать стратегии для улучшения затрат на газ. Эти стратегии, безусловно, обширны, и этот учебник охватывает лишь некоторые базовые примеры.

### Использование оптимизатора

Из предыдущего отчета видно, что оптимизатор проекта имеет значение 10000 runs. Это означает, что затраты на развертывание будут выше. Однако если изменить это значение на 200, получится:

```
·------------------------|---------------------------|-------------|-----------------------------·
|  Solc version: 0.8.18  ·  Optimizer enabled: true  ·  Runs: 200  ·  Block limit: 30000000 gas  │
·························|···························|·············|······························
|  Methods                                                                                       │
·············|···········|·············|·············|·············|···············|··············
|  Contract  ·  Method   ·  Min        ·  Max        ·  Avg        ·  # calls      ·  usd (avg)  │
·············|···········|·············|·············|·············|···············|··············
|  Store     ·  addItem  ·          -  ·          -  ·     113619  ·            1  ·          -  │
·············|···········|·············|·············|·············|···············|··············
|  Deployments           ·                                         ·  % of limit   ·             │
·························|·············|·············|·············|···············|··············
|  Store                 ·          -  ·          -  ·     357505  ·        1.2 %  ·          -  │
·------------------------|-------------|-------------|-------------|---------------|-------------·
```

Это автоматически дает некоторые улучшения для затрат газа на развертывание, но немного увеличивает затраты на выполнение транзакций.

### Использование неизменяемых (immutable) переменных

В нашем контракте `Store` можно определить определенные переменные, которые устанавливаются только во время создания контракта. Это означает, что есть возможность превратить эти переменные в неизменяемые (immutable), поскольку неизменяемым переменным все еще можно присвоить значение во время конструирования.

Если вы измените контракт `Store` на:

```solidity
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

contract Store {
    address immutable owner;
    uint256 public numberOfItems;

    struct Item {
        uint256 id;
        string description;
        uint256 price;
    }

    // id => item
    mapping(uint256 => Item) public items;

    constructor() {
        owner = msg.sender;
    }

    function addItem(string memory description, uint256 price) external {
        require(msg.sender == owner, "invalid owner");

        numberOfItems++;

        items[numberOfItems] = Item(
            numberOfItems,
            description,
            price
        );
    }
}
```

Затем запустите gas reporter. Вы должны увидеть:

```
·------------------------|---------------------------|-------------|-----------------------------·
|  Solc version: 0.8.18  ·  Optimizer enabled: true  ·  Runs: 200  ·  Block limit: 30000000 gas  │
·························|···························|·············|······························
|  Methods                                                                                       │
·············|···········|·············|·············|·············|···············|··············
|  Contract  ·  Method   ·  Min        ·  Max        ·  Avg        ·  # calls      ·  usd (avg)  │
·············|···········|·············|·············|·············|···············|··············
|  Store     ·  addItem  ·          -  ·          -  ·     111525  ·            1  ·          -  │
·············|···········|·············|·············|·············|···············|··············
|  Deployments           ·                                         ·  % of limit   ·             │
·························|·············|·············|·············|···············|··············
|  Store                 ·          -  ·          -  ·     329580  ·        1.1 %  ·          -  │
·------------------------|-------------|-------------|-------------|---------------|-------------·
```

Что уже демонстрирует некоторые улучшения.

### Избегайте ненужного хранения данных

Хранение данных и отказ от хранения данных в смарт-контракте - это дизайнерское решение, имеющее плюсы и минусы. Некоторые из плюсов, безусловно, заключаются в том, что вся информация хранится в смарт-контракте, и вам не обязательно полагаться на события или другие сервисы для доступа к хранилищу контракта. Однако минусом хранения всей информации в контракте является тот факт, что выполнение действий с контрактом будет дороже.

В смарт-контракте `Store` есть следующее:

```solidity
struct Item {
        uint256 id;
        string description;
        uint256 price;
    }

// id => item
mapping(uint256 => Item) public items;
```

Присмотревшись, можно заметить, что `Id` структуры  `Item` и `id` используемый в маппинге (mapping), одинаковы. Вы можете избежать дублирования этой информации, удалив id из структуры `Item`.

Контракт будет выглядеть так:

```solidity
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

contract Store {
    address immutable owner;
    uint256 public numberOfItems;

    struct Item {
        string description;
        uint256 price;
    }

    // id => item
    mapping(uint256 => Item) public items;

    constructor() {
        owner = msg.sender;
    }

    function addItem(string memory description, uint256 price) external {
        require(msg.sender == owner, "invalid owner");

        numberOfItems++;

        items[numberOfItems] = Item(
            description,
            price
        );
    }
}
```

Если вы запустите gas reporter, то получите:

```
·------------------------|---------------------------|-------------|-----------------------------·
|  Solc version: 0.8.18  ·  Optimizer enabled: true  ·  Runs: 200  ·  Block limit: 30000000 gas  │
·························|···························|·············|······························
|  Methods                                                                                       │
·············|···········|·············|·············|·············|···············|··············
|  Contract  ·  Method   ·  Min        ·  Max        ·  Avg        ·  # calls      ·  usd (avg)  │
·············|···········|·············|·············|·············|···············|··············
|  Store     ·  addItem  ·          -  ·          -  ·      89371  ·            1  ·          -  │
·············|···········|·············|·············|·············|···············|··············
|  Deployments           ·                                         ·  % of limit   ·             │
·························|·············|·············|·············|···············|··············
|  Store                 ·          -  ·          -  ·     322251  ·        1.1 %  ·          -  │
·------------------------|-------------|-------------|-------------|---------------|-------------·
```

Это демонстрирует еще одно улучшение в потреблении газа смарт-контрактом `Store`. Однако можно пойти дальше и вместо хранения предметов в `mapping`, можно просто отправлять `events` и использовать события как дешевую форму хранения.

Например, можно изменить контракт так:

```solidity
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

contract Store {
    address immutable owner;
    uint256 public numberOfItems;

    struct Item {
        string description;
        uint256 price;
    }

    event ItemCreated(uint256 id, Item item);

    constructor() {
        owner = msg.sender;
    }

    function addItem(string memory description, uint256 price) external {
        require(msg.sender == owner, "invalid owner");

        numberOfItems++;

        emit ItemCreated(numberOfItems, Item(description, price));
    }
}
```

Обратите внимание, как вместо хранения предметов вы отправляете событие `ItemCreated`, что снижает затраты газа на развертывание и выполнение:

```
·------------------------|---------------------------|-------------|-----------------------------·
|  Solc version: 0.8.18  ·  Optimizer enabled: true  ·  Runs: 200  ·  Block limit: 30000000 gas  │
·························|···························|·············|······························
|  Methods                                                                                       │
·············|···········|·············|·············|·············|···············|··············
|  Contract  ·  Method   ·  Min        ·  Max        ·  Avg        ·  # calls      ·  usd (avg)  │
·············|···········|·············|·············|·············|···············|··············
|  Store     ·  addItem  ·          -  ·          -  ·      47315  ·            1  ·          -  │
·············|···········|·············|·············|·············|···············|··············
|  Deployments           ·                                         ·  % of limit   ·             │
·························|·············|·············|·············|···············|··············
|  Store                 ·          -  ·          -  ·     208252  ·        0.7 %  ·          -  │
·------------------------|-------------|-------------|-------------|---------------|-------------·
```

Как видите, улучшения с точки зрения потребления газа значительны. Однако недостатком является то, что теперь для доступа ко всем предметам необходимо просматривать все события `ItemCreated, отправленные контрактом.

### Использование пользовательских ошибок

Еще один распространенный способ оптимизировать затраты на газ - это удаление `require`s и использование пользовательских ошибок (custom errors). Например, можно сделать следующее:

```solidity
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

contract Store {
    address immutable owner;
    uint256 public numberOfItems;

    error InvalidOwner();

    struct Item {
        string description;
        uint256 price;
    }

    event ItemCreated(uint256 id, Item item);

    constructor() {
        owner = msg.sender;
    }

    function addItem(string memory description, uint256 price) external {
        if(msg.sender != owner){
            revert InvalidOwner();
        }

        numberOfItems++;

        emit ItemCreated(numberOfItems, Item(description, price));
    }
}
```

Что дает следующий отчет:

```
·------------------------|---------------------------|-------------|-----------------------------·
|  Solc version: 0.8.18  ·  Optimizer enabled: true  ·  Runs: 200  ·  Block limit: 30000000 gas  │
·························|···························|·············|······························
|  Methods                                                                                       │
·············|···········|·············|·············|·············|···············|··············
|  Contract  ·  Method   ·  Min        ·  Max        ·  Avg        ·  # calls      ·  usd (avg)  │
·············|···········|·············|·············|·············|···············|··············
|  Store     ·  addItem  ·          -  ·          -  ·      47315  ·            1  ·          -  │
·············|···········|·············|·············|·············|···············|··············
|  Deployments           ·                                         ·  % of limit   ·             │
·························|·············|·············|·············|···············|··············
|  Store                 ·          -  ·          -  ·     200683  ·        0.7 %  ·          -  │
·------------------------|-------------|-------------|-------------|---------------|-------------·
```

Обратите внимание на улучшение затрат газа на развертывание.

## Заключение

В этом учебнике вы узнали о некоторых распространенных стратегиях профилирования и оптимизации расхода газа ваших смарт-контрактов с использованием среды разработки Hardhat и плагина Hardhat Gas Reporter. Реализуя эти стратегии и используя плагин Hardhat Gas Reporter, вы можете создавать более эффективные и экономичные смарт-контракты на благо пользователей, поскольку это означает меньшие затраты на газ.

---

[Hardhat Gas Reporter]: https://www.npmjs.com/package/hardhat-gas-reporter
