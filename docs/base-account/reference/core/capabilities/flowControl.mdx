---
title: "flowControl"
description: "Управление поведением пакета транзакций после неудачных или отмененных вызовов"
---

Определено в [ERC-7867](https://github.com/ethereum/ERCs/pull/7867) (Предложено)

<Info>
Возможность flowControl позволяет dapp указывать, как пакеты транзакций должны вести себя при сбое или отмене отдельных вызовов. Это обеспечивает детальный контроль над потоком выполнения транзакций и позволяет реализовать более сложные стратегии обработки ошибок.
</Info>

<Warning>
Эта возможность в настоящее время предложена в ERC-7867 и еще не окончательна. Детали реализации могут измениться по мере развития спецификации.
</Warning>

## Параметры

<ParamField body="onFailure" type="string">
Определяет поведение при сбое или отмене вызова транзакции.

**Возможные значения:**
- `"continue"`: Продолжить выполнение оставшихся вызовов
- `"stop"`: Остановить выполнение при сбое
- `"retry"`: Попытаться повторить неудачный вызов
</ParamField>

<ParamField body="fallbackCall" type="object">
Опциональная запасная транзакция для выполнения в случае сбоя основного вызова.

<Expandable title="Свойства FallbackCall">
<ParamField body="to" type="string" required>
Адрес получателя для запасного вызова.
</ParamField>

<ParamField body="value" type="string">
Значение для отправки с запасным вызовом (в wei, hex-формат).
</ParamField>

<ParamField body="data" type="string">
Данные вызова для запасного вызова (hex-формат).
</ParamField>
</Expandable>
</ParamField>

## Возвращает

<ResponseField name="flowControl" type="object">
Конфигурация возможности управления потоком для указанной цепочки.

<Expandable title="Свойства возможности FlowControl">
<ResponseField name="supported" type="boolean">
Указывает, поддерживает ли кошелек функциональность управления потоком.
</ResponseField>
</Expandable>
</ResponseField>

## Пример использования

<RequestExample>
```typescript Check Flow Control Support
const capabilities = await provider.request({
  method: 'wallet_getCapabilities',
  params: [userAddress]
});

const flowControlCapability = capabilities["0x2105"]?.flowControl;
```

```typescript Proposed Usage (Subject to Change)
const result = await provider.request({
  method: 'wallet_sendCalls',
  params: [{
    version: "1.0",
    chainId: "0x2105",
    from: userAddress,
    calls: [
      {
        to: "0x1234567890123456789012345678901234567890",
        value: "0x0",
        data: "0xa9059cbb000000000000000000000000...",
        flowControl: {
          onFailure: "continue",
          fallbackCall: {
            to: "0x...",
            data: "0x..."
          }
        }
      }
    ]
  }]
});
```
</RequestExample>

<ResponseExample>
```json Capability Response (Supported)
{
  "0x2105": {
    "flowControl": {
      "supported": true
    }
  }
}
```

```json Capability Response (Unsupported)
{
  "0x2105": {
    "flowControl": {
      "supported": false
    }
  }
}
```
</ResponseExample>

## Обработка ошибок

| Код  | Сообщение | Описание |
| ---- | --------- | -------- |
| 4100 | Flow control not supported | Кошелек не поддерживает функциональность управления потоком |
| 5700 | Flow control capability required | Транзакция требует управления потоком, но кошелек не поддерживает его |
| 5800 | Invalid flow control parameters | Предоставленная конфигурация управления потоком неверна |

## Потенциальные сценарии использования

### Транзакции электронной коммерции

Обработка сценариев, когда одни покупки успешны, а другие завершаются сбоем:

```typescript
// Пример: Покупка нескольких товаров с управлением потоком
const purchaseResult = await provider.request({
  method: 'wallet_sendCalls',
  params: [{
    version: "1.0",
    chainId: "0x2105",
    from: userAddress,
    calls: [
      // Покупка основного товара
      {
        to: marketplaceContract,
        value: "0x0",
        data: purchaseItem1CallData,
        flowControl: { onFailure: "continue" }
      },
      // Покупка дополнительного товара
      {
        to: marketplaceContract,
        value: "0x0", 
        data: purchaseItem2CallData,
        flowControl: { onFailure: "continue" }
      },
      // Обработка платежа (критично)
      {
        to: paymentContract,
        value: "0x16345785d8a0000",
        data: "0x",
        flowControl: { onFailure: "stop" }
      }
    ]
  }]
});
```

### DeFi-операции с запасными вариантами

Реализация сложных DeFi-стратегий с резервными вариантами:

```typescript
// Пример: Обмен с запасным маршрутом
const swapWithFallback = await provider.request({
  method: 'wallet_sendCalls',
  params: [{
    version: "1.0",
    chainId: "0x2105", 
    from: userAddress,
    calls: [
      // Основной обмен на DEX
      {
        to: primaryDexAddress,
        value: "0x0",
        data: primarySwapCallData,
        flowControl: {
          onFailure: "fallback",
          fallbackCall: {
            to: secondaryDexAddress,
            data: secondarySwapCallData
          }
        }
      }
    ]
  }]
});
```

### Пакетные операции с восстановлением ошибок

Выполнение пакетных операций, которые могут корректно обрабатывать отдельные сбои:

```typescript
// Пример: Массовые разрешения токенов с восстановлением
const bulkApprovals = await provider.request({
  method: 'wallet_sendCalls',
  params: [{
    version: "1.0",
    chainId: "0x2105",
    from: userAddress,
    calls: tokenAddresses.map((token, index) => ({
      to: token,
      value: "0x0",
      data: approveCallData,
      flowControl: {
        onFailure: "continue", // Не останавливать пакет при сбое одного разрешения
        retryCount: 2 // Повторить неудачные разрешения
      }
    }))
  }]
});
```

## Проверка поддержки возможности

После реализации проверяйте поддержку управления потоком:

```typescript
async function checkFlowControlSupport() {
  try {
    const capabilities = await provider.request({
      method: 'wallet_getCapabilities',
      params: [userAddress]
    });
    
    const flowControlCapability = capabilities["0x2105"]?.flowControl;
    
    if (flowControlCapability?.supported) {
      console.log("Flow control capability supported");
      return true;
    } else {
      console.log("Flow control capability not supported");
      return false;
    }
  } catch (error) {
    console.error("Error checking flow control capability:", error);
    return false;
  }
}
```

## Ожидаемые преимущества

После реализации управление потоком предоставит:

1. **Лучший пользовательский опыт**: Частичный успех вместо полной неудачи
2. **Гибкая обработка ошибок**: Приложения могут определять собственные реакции на сбои
3. **Сокращение потерь газа**: Избежание повторного выполнения успешных операций
4. **Сложные рабочие процессы**: Включение сложных многоэтапных процессов

## Статус разработки

Эта возможность активно разрабатывается:

- **ERC-7867**: Формальное предложение для возможности управления потоком
- **Вклад сообщетсва**: Постоянные обсуждения деталей реализации
- **Интеграция в кошельки**: Ожидается окончание спецификации

## Подготовка к управлению потоком

В ожидании реализации разработчики могут:

1. **Проектировать гибкую архитектуру**: Создавать приложения, которые могут адаптироваться к различным моделям выполнения
2. **Реализовать логику откатов**: Создавать ручные стратегии откатов для критических операций
3. **Следить за спецификацией**: Отслеживать прогресс ERC-7867 для обновлений реализации
4. **Тестировать последовательное выполнение**: Использовать текущие возможности для имитации поведения управления потоком

<Info>
Следите за разработкой ERC-7867, чтобы реализовать управление потоком, как только оно станет доступно в рабочих кошельках.
</Info>

<Warning>
Приведенные выше примеры являются концептуальными и могут не отражать окончательную реализацию. Всегда обращайтесь к последней спецификации ERC-7867 для получения точных деталей.
</Warning>

## Связанные возможности

Управление потоком работает совместно с другими возможностями:

- **[Атомарность (Atomic)](/base-account/reference/core/capabilities/atomic)**: Для строгого выполнения "все или ничего"
- **[Сервис Paymaster](/base-account/reference/core/capabilities/paymasterService)**: Для спонсируемых потоков транзакций
- **[Вспомогательные средства (Auxiliary Funds)](/base-account/reference/core/capabilities/auxiliaryFunds)**: Для гибких источников финансирования

import PolicyBanner from "/snippets/PolicyBanner.mdx";

<PolicyBanner />
