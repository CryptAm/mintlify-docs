---
title: "Разрешения на траты"
description: "Включите доверенным сторонам возможность перемещать активы без дополнительных подписей"
---

import { GithubRepoCard } from "/snippets/GithubRepoCard.mdx";

Узнайте, как создавать и управлять Разрешениями на траты, которые позволяют доверенным сторонам перемещать активы из Base Accounts без необходимости дополнительных подписей пользователя.

## Обзор

Разрешения на траты позволяют пользователям предоставлять своевременные лимиты доверенным сторонам, позволяя им перемещать активы от имени пользователя в рамках определенных ограничений. Это создает бесшовный пользовательский опыт для повторяющихся платежей, подписок и автоматизированных транзакций.

### Что вы получите

К концу этого руководства вы сможете:

- Создавать Разрешения на траты с определенными лимитами и временными периодами
- Получать и управлять существующими разрешениями
- Использовать Разрешения на траты для выполнения транзакций
- Реализовать функциональность Разрешений на траты в вашем React-приложении

Фрагменты кода в этом руководстве основаны на следующем примере проекта:

<GithubRepoCard
  title="Шаблон Base Account Privy"
  githubUrl="https://github.com/base/base-account-privy"
/>

## Настройка

Следуйте руководству [настройки](/base-account/framework-integrations/privy/setup) чтобы настроить Privy с Base Account.

## Реализация

### Настройка компонента

<CodeGroup>
```tsx Spend Permissions Component (components/sections/spend-permissions.tsx) expandable
"use client";

import { useState, useEffect, useCallback, useMemo } from "react";
import { useBaseAccountSdk, useWallets } from "@privy-io/react-auth";
import {
  requestSpendPermission,
  prepareSpendCallData,
  fetchPermissions,
  getPermissionStatus,
  type SpendPermission,
} from "@base-org/account/spend-permission/browser";
import { base } from "@privy-io/chains";

export const SpendPermissions = () => {
  const { baseAccountSdk } = useBaseAccountSdk();
  const { wallets } = useWallets();
  const [permissions, setPermissions] = useState<SpendPermission[]>([]);
  const [selectedPermission, setSelectedPermission] = useState<SpendPermission | null>(null);
  const [loading, setLoading] = useState(false);
  
  // Конфигурация
  const spenderAddress = "0xd8da6bf26964af9d7eed9e03e53415d37aa96045";
  const tokenAddress = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"; // USDC on Base

  // Находим кошелек Base Account
  const baseAccount = useMemo(() => {
    return wallets.find((wallet) => wallet.walletClientType === 'base_account');
  }, [wallets]);

  const provider = baseAccountSdk?.getProvider();
  const account = baseAccount?.address;

  const loadPermissions = useCallback(async () => {
    if (!account || !provider || !spenderAddress) return;
    
    try {
      setLoading(true);
      const fetchedPermissions = await fetchPermissions({
        account,
        chainId: base.id,
        spender: spenderAddress,
        provider,
      });
      setPermissions(fetchedPermissions);
    } catch (error) {
      console.error("Failed to load permissions:", error);
    } finally {
      setLoading(false);
    }
  }, [account, provider, spenderAddress]);

  const handleRequestSpendPermission = async () => {
    if (!account || !provider || !spenderAddress || !tokenAddress) return;

    try {
      setLoading(true);
      
      const permission = await requestSpendPermission({
        account,
        spender: spenderAddress,
        token: tokenAddress,
        chainId: base.id,
        allowance: BigInt(1) * BigInt(10 ** 6), // 1 USDC (6 decimals)
        periodInDays: 1, // 1 day
        provider,
      });

      setPermissions([...permissions, permission]);
    } catch (error) {
      console.error("Failed to create Spend Permission:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleUseSpendPermission = async () => {
    if (!selectedPermission || !provider || !spenderAddress) return;

    try {
      setLoading(true);
      
      // Проверяем статус разрешения
      const { isActive, remainingSpend } = await getPermissionStatus(selectedPermission);
      
      if (!isActive) {
        console.error("Selected permission is not active");
        return;
      }

      const spendAmount = BigInt(100) * BigInt(10 ** 6); // 100 USDC
      
      if (remainingSpend < spendAmount) {
        console.error("Insufficient remaining allowance");
        return;
      }

      // Подготавливаем вызовы для траты
      const spendCalls = await prepareSpendCallData(selectedPermission, spendAmount);
      console.log("Spend calls prepared:", spendCalls);
      
    } catch (error) {
      console.error("Failed to use Spend Permission:", error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-4">
      <div className="flex gap-4">
        <button 
          onClick={handleRequestSpendPermission}
          disabled={loading || !account}
          className="px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50"
        >
          Создать Разрешение на траты
        </button>
        <button 
          onClick={loadPermissions}
          disabled={loading || !account}
          className="px-4 py-2 bg-green-600 text-white rounded disabled:opacity-50"
        >
          Загрузить разрешения
        </button>
        <button 
          onClick={handleUseSpendPermission}
          disabled={loading || !selectedPermission}
          className="px-4 py-2 bg-purple-600 text-white rounded disabled:opacity-50"
        >
          Использовать разрешения
        </button>
      </div>

      {/* Отображение конфигурации */}
      <div className="p-4 rounded-lg">
        <h4 className="font-semibold mb-3">Configuration</h4>
        <div className="text-sm space-y-1">
          <div><strong>Spender:</strong> {spenderAddress}</div>
          <div><strong>Token:</strong> {tokenAddress} (USDC)</div>
          <div><strong>Allowance:</strong> $1 USDC per day</div>
        </div>
      </div>

      {/* Список разрешений */}
      {permissions.length > 0 && (
        <div className="p-4 rounded-lg">
          <h4 className="font-semibold mb-3">Existing Permissions</h4>
          <div className="space-y-2">
            {permissions.map((permission, index) => (
              <div
                key={index}
                className={`p-3 border rounded-md cursor-pointer ${
                  selectedPermission === permission
                    ? "border-blue-500"
                    : "border-gray-300"
                }`}
                onClick={() => setSelectedPermission(permission)}
              >
                <div className="text-sm">
                  <div><strong>Spender:</strong> {permission.permission.spender?.slice(0, 10)}...</div>
                  <div><strong>Token:</strong> {permission.permission.token?.slice(0, 10)}...</div>
                  <div><strong>Allowance:</strong> {permission.permission.allowance?.toString()}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};
```
</CodeGroup>

### Ключевые методы

#### Создание Разрешений на траты

Используйте `requestSpendPermission` для создания новых Разрешений на траты:

```tsx
const permission = await requestSpendPermission({
  account,
  spender: spenderAddress,
  token: tokenAddress,
  chainId: base.id,
  allowance: BigInt(1) * BigInt(10 ** 6), // 1 USDC
  periodInDays: 1, // 1 день
  provider,
});
```

#### Получение разрешений

Используйте `fetchPermissions` для получения существующих разрешений:

```tsx
const permissions = await fetchPermissions({
  account,
  chainId: base.id,
  spender: spenderAddress,
  provider,
});
```

#### Использование разрешений

Проверьте статус разрешения и подготовьте вызовы для траты:

```tsx
// Проверяем, активно ли разрешение
const { isActive, remainingSpend } = await getPermissionStatus(permission);

// Подготавливаем данные транзакции для траты
const spendCalls = await prepareSpendCallData(permission, spendAmount);
```

### Параметры конфигурации

#### Лимит и период

Настройте лимиты трат и временные периоды:

```tsx
{
  allowance: BigInt(100) * BigInt(10 ** 6), // 100 USDC (6 decimals)
  periodInDays: 7, // 7 дней
}
```

#### Адреса токенов

Распространенные адреса токенов в сети Base:

- **USDC**: `0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913`
- **ETH**: Native token `0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE`
- **DAI**: `0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb`

### Сценарии использования

Разрешения на траты идеально подходят для:

- **Подписок**: Повторяющиеся платежи без взаимодействия с пользователем
- **DeFi-протоколов**: Автоматизированная торговля и фарминг доходности
- **Игр**: Внутриигровые покупки и награды
- **Электронной коммерции**: Упрощенные процессы оформления заказа

<GithubRepoCard
  title="Шаблон Base Account Privy"
  githubUrl="https://github.com/base/base-account-privy"
/>
